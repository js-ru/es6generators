## Основы Koa {#koa-basics}

Koa очень лёгкий в настройке и в использовании фреймворк. Каждое приложение создает разный мидлвар для обработки запросов и генерации ответов. Каждый мидлвар — это функция-генератор, которая регистрируется с использованием `use()` в приложении Koa. Мидлвары обрабатываются последовательно в том порядком, в котором они зарегистрированы. Каждый мидлвар может получить доступ к данным контекста, используя `this`, например, это могут быть `request`,` response`, `method` и `url`.

Код ниже — это простое приложение на Koa. Оно регистрирует две функции-генераторы мидлвара: первая используется для логирования времени обработки запроса, а вторая используется для установки тела ответа `Привет, мир`.

```js
var koa = require('koa');
var app = koa();

app.use(function *log(next) {
  console.log('ЛОГИРОВАНИЕ — запись даты начала запроса');
  var start = new Date;
  yield next;
  var ms = new Date - start;
  console.log('ЛОГИРОВАНИЕ — %s %s => %s', this.method, this.url, ms);
});

app.use(function *setBody() {
  console.log('Установка тела ответа');
  this.body = 'Привет, мир';
});

app.listen(3000);
```

Каждая функция-генератор мидлвара может принимать дополнительный аргумент, который представляет собой следующий мидлвар в цепочке. Если функции-генератору мидлвара потребуется перехватить выполнение последующего мидлвара в цепочке, она сначала может выполнить определённые задачи, а затем вызвать `yield` для делегирования выполнения другому мидлвару, после чего выполнить оставшийся задачи после завершения следующего мидлвара. Функция-генератор мидлвара логирования в приведённом выше коде демонстрирует этот алгоритм действий. Сначала записывается время начала, когда приходит запрос, затем вызывается `yield next` для передачи выполнения следующему мидлвару, и, наконец, записывается время завершения и происходит вычисление продолжительности запроса.

После перехода на адрес `http://localhost:3000` в консоле будет выведено примерно следующее:

```plaintext
ЛОГИРОВАНИЕ - запись даты начала запроса
Установка тела ответа
ЛОГИРОВАНИЕ - GET / => 5
```

I> Если вы знаете про [АОП](https://ru.wikipedia.org/wiki/%D0%90%D1%81%D0%BF%D0%B5%D0%BA%D1%82%D0%BD%D0%BE-%D0%BE%D1%80%D0%B8%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5), то мидлвар с выражением `yield` похож на [around advice](http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop.html#aop-ataspectj-around-advice).
