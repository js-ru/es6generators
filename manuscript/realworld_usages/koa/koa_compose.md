## `koa-compose`

I> Код ниже основан на более ранней версии `koa-compose`. Последняя версия изменилась в пользу использования `Promise` вместо генераторов. Тем не менее, код по-прежнему пригодится для понимания генераторов.

[`koa-compose`](https://github.com/koajs/compose) —небольшая библиотека, которая объединяет функции-генераторы мидлваров. Его [исходный код](https://github.com/koajs/compose/blob/v2.x/index.js) очень простой, всего 29 непустых строк кода. `compose` — основной метод для формирования мидлваров. Аргумент `middleware` — массив функций-генераторов мидлваров в порядке регистрации. Возвращаемое значение метода `compose` — функция-генератор с аргументом `next`. `next` — необязательная функция-генератор, которая является последним мидлваром в цепочке.

```js
function compose(middleware) {
  return function *(next) {
    if (!next) next = noop();

    var i = middleware.length;

    while (i--) {
      next = middleware[i].call(this, next);
    }

    return yield *next;
  }
}

function *noop(){}
```

Давайте построчно пройдёмся через код функции-генератора. Первая строка `if (!next) next = noop();` устанавливает `next` в функцию-генератор, которая ничего не делает, `noop`, если значение равно `null`. `i` - это переменная цикла массива `middleware`, начиная с последнего мидлвара в массиве. В цикле `while` функция-генератор каждого мидлвара вызывается с текущим значением `next` в качестве аргумента, возвращаемый объект-генератор присваивается в виде нового значения для `next`. Затем `yield*` используется для делегирования на завершающий объект-генератора `next`.

Посмотрим, как мидлвар используется в примере приложения из [основ Koa](#koa-basics). Массив `middleware` содержит две функции-генераторы: `log` и `setBody`. В цикле `while` функция-генератор `setBody` вызывается сначала с аргументом `next`, установленным в `noop`, а `next` устанавливается в объект-генератор `setBody`. Затем вызывается функция-генератор `log` с аргументом `next`, установленным в объект-генератор `setBody`, а `next` устанавливается в объект-генератор `log`. Последнее выражение `yield* next` делегирует выполнение объекту-генератору `log`.

Возвращенная функция-генератор `compose` превращается в обычную функцию, возвращающая `Promise`, используя `co.wrap` из [co](#co). Обёрнутая функция является фактическим обработчиком запросов. Когда приходит запрос, объект-генератор `log` запускает выполнение первым и работает до выражения `yield next`, таким образом записывается время начала запроса. `next` — это объект-генератор `setBody`, вызывающий `yield next`, запускает выполнение `setBody` и задаёт тело ответа. Наконец, объект-генератор `log` возобновляет выполнение и вычисляет продолжительность запроса.